<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="page_title">MALFIT | Calorie</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script> 

    <style>
        /* Custom styles from the previous file */
        :root {
            --primary-color: #4f46e5; /* Default: indigo-600 */
            --primary-light: #eef2ff; /* Default: indigo-50 */
            --logo-color: #4f46e5;
            --calc-gradient-start: #4f46e5; /* Indigo */
            --calc-gradient-end: #3b82f6; /* Blue */
            --result-text-color: #3730a3; /* Indigo-800 */
            --result-highlight-color: #4338ca; /* Indigo-700 */
        }
        
        /* --- START: FEMALE THEME OVERRIDE --- */
        .female-theme {
            --primary-color: #ec4899; /* Pink-600 */
            --primary-light: #fdf2f8; /* Pink-50 */
            --logo-color: #ec4899;
            --calc-gradient-start: #ec4899; /* Pink */
            --calc-gradient-end: #f43f5e; /* Rose */
            --result-text-color: #9d174d; /* Pink-800 */
            --result-highlight-color: #be185d; /* Pink-700 */
        }
        
        /* Hide Period link until Female theme is active. Use a class that can be toggled by CSS/JS. */
        .period-link {
            display: none !important;
        }
        .female-theme .period-link {
            display: flex !important; /* Show on desktop nav (flex layout) */
        }
        /* Mobile menu links are typically block elements */
        #mobile-menu a.period-link {
            display: block !important; 
        }
        /* --- END: FEMALE THEME OVERRIDE --- */


        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* Softer, slightly blue background */
            overflow-x: hidden; 
            min-height: 100vh;
            position: relative; 
        }

        /* Apply Arabic font when direction is RTL */
        html[dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }

        /* --- Custom Nav Link Styles (Pill-shaped) --- */
        .nav-link {
            text-decoration: none;
            color: #474646;
            font-weight: 500;
            padding: 10px 15px; 
            margin-right: 10px;
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
            border-radius: 9999px; /* Pill shape */
            white-space: nowrap;
        }
        /* Highlight the active link for this page */
        .nav-link.active-calorie {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            font-weight: 700;
        }
        .nav-link:hover {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            transform: translateY(-1px);
        }
        
        /* Adjustments for RTL layout for links */
        html[dir="rtl"] header nav .nav-link {
            margin-right: 0;
            margin-left: 10px;
        }
        
        /* --- Header Specific Styles --- */
        header {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Stronger header shadow */
            background-color: #ffffff;
            transition: box-shadow 0.3s ease-in-out;
        }
        
        /* --- Mobile Menu Styles (Using existing Tailwind classes for responsiveness) --- */
        #mobile-menu {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            background-color: #ffffff;
            position: absolute;
            top: 70px; 
            right: 0;
            left: 0;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        #mobile-menu.active {
            max-height: 500px;
            opacity: 1;
            padding: 10px 0;
        }
        #mobile-menu a {
            display: block;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            color: #333;
            text-decoration: none;
            text-align: left; 
            transition: background-color 0.15s;
        }
        #mobile-menu a:hover {
            background-color: var(--primary-light);
        }
        html[dir="rtl"] #mobile-menu a {
            text-align: right; 
        }

        /* Icon Button Styling */
        .icon-btn {
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-700 */
        }
        .icon-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        /* Specific RTL fix for button icon placement (mr-2 equivalent for RTL) */
        .rtl-ml-2 {
            margin-right: 0.5rem; 
        }
        html[dir="rtl"] .rtl-ml-2 {
            margin-right: 0;
            margin-left: 0.5rem; 
        }
        
        /* Enhanced Contact Button Gradient - Uses CSS variables */
        .contact-btn {
            background-image: linear-gradient(to right, var(--calc-gradient-start) 0%, var(--calc-gradient-end) 100%); 
            transition: all 0.2s ease;
        }
        .contact-btn:hover {
            box-shadow: 0 8px 15px rgba(63, 131, 248, 0.4); /* General shadow for hover effect */
            transform: scale(1.02);
            opacity: 0.95;
        }
        
        /* Centering for the main card container */
        .min-h-main {
            min-height: calc(100vh - 140px);
        }
        @media (min-width: 768px) {
            .min-h-main {
                min-height: calc(100vh - 120px); 
            }
        }

        /* Calculator Specific Styles */
        .input-style {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
            color: #1f2937;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--primary-color); /* Uses CSS Variable */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .result-box-style {
            background-color: var(--primary-light); /* Uses CSS Variable */
            border-left: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
        html[dir="rtl"] .result-box-style {
            border-left: none;
            border-right: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
        
        /* Result Box inner content styling using CSS variables */
        .result-inner-box {
             background-color: var(--primary-light);
        }
        .result-title-style {
            color: var(--result-text-color);
        }
        .result-number-style {
            color: var(--result-highlight-color);
        }
    </style>
</head>
<body onload="loadUserPreferences()">
    
    <header class="sticky top-0 z-50 w-full flex items-center justify-between px-4 md:px-8 lg:px-16 py-3 bg-white border-b border-gray-100">
        
        <div class="flex items-center">
            <a href="../Home/home.html" id="logo" class="text-3xl font-extrabold text-indigo-600 tracking-wide" data-translate-key="logo" aria-label="Go to Homepage">MALFIT</a>
        </div>

        <nav class="hidden md:flex flex-grow justify-center mx-10">
            <a href="calories.html" class="nav-link active-calorie" data-translate-key="nav_calories">Calories</a>
            <a href="../Period/period.html" id="nav-period-desktop" class="nav-link period-link" data-translate-key="nav_period">Period</a>
            <a href="../Eat healthy/eat healthy.html" class="nav-link" data-translate-key="nav_eat_healthy">Eat Healthy</a>
            <a href="../Plans/plans.html" class="nav-link" data-translate-key="nav_plans">Plans</a>
            <a href="../Clubs/clubs.html" class="nav-link" data-translate-key="nav_clubs">Clubs</a>
            <a href="../Survey/survey.html" class="nav-link" data-translate-key="nav_survey">Survey</a>
            <a href="../Contact us/contact us.html" class="nav-link" data-translate-key="nav_contact_us">Contact Us</a>
        </nav>

        <div class="icons-container flex items-center gap-2 md:gap-4">
            
            <button id="lang-toggle" onclick="toggleLanguage()" class="icon-btn w-10 h-10 border-2 border-gray-300 hover:border-indigo-600" aria-label="Toggle language">
                <span id="current-lang" class="text-sm font-bold">EN</span> 
            </button>

            <a href="../Home/home.html" class="icon-btn hover:bg-indigo-50" aria-label="Home">
                <svg data-lucide="home" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <a href="../Account/account.html" class="icon-btn hover:bg-indigo-50" aria-label="Account Settings"> 
                <svg data-lucide="user" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <button id="menu-toggle" onclick="toggleMobileMenu()" class="md:hidden icon-btn" aria-label="Toggle mobile menu">
                <svg data-lucide="menu" width="24" height="24" aria-hidden="true"></svg>
            </button>
        </div>
    </header>

    <div id="mobile-menu" class="md:hidden">
        <a href="calories.html" data-translate-key="nav_calories">Calories</a>
        <a href="../Period/period.html" id="nav-period-mobile" class="period-link" data-translate-key="nav_period">Period</a>
        <a href="../Eat healthy/eat healthy.html" data-translate-key="nav_eat_healthy">Eat Healthy</a>
        <a href="../Plans/plans.html" data-translate-key="nav_plans">Plans</a>
        <a href="../Clubs/clubs.html" data-translate-key="nav_clubs">Clubs</a>
        <a href="../Survey/survey.html" data-translate-key="nav_survey">Survey</a>
        <a href="../Contact us/contact us.html" data-translate-key="nav_contact_us">Contact Us</a>
    </div>

    <main class="flex items-center justify-center p-4 min-h-main"> 
    
        <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 sm:p-8 border border-blue-50/50 transform transition-all duration-300 hover:shadow-indigo-200/50">

            <div class="text-center">
                <div id="calculator-icon-container" class="mx-auto w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                    <svg data-lucide="calculator" width="28" height="28" stroke="white" stroke-width="2.5" aria-hidden="true"></svg>
                </div>
                <h1 class="mt-6 text-3xl font-extrabold text-gray-900 leading-tight" data-translate-key="calc_title">Calculate Calories</h1>
                <p class="mt-3 text-md text-gray-500 max-w-md mx-auto" data-translate-key="calc_subtitle">Find your daily calorie target based on your goal.</p>
            </div>

            <div class="space-y-4 mt-8">
                <div class="flex space-x-4 rtl:space-x-reverse">
                    <div class="w-1/2">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_age">Your Age (Years)</label>
                        <input type="number" id="age" min="15" class="input-style" placeholder="e.g., 30" required>
                    </div>
                    <div class="w-1/2">
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_gender">Are you Male or Female?</label>
                        <select id="gender" class="input-style" onchange="updateTheme(this.value); toggleCycleTrackingFields();" required>
                            <option value="male" data-translate-key="option_male" selected>Male</option>
                            <option value="female" data-translate-key="option_female">Female</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-4 rtl:space-x-reverse">
                    <div class="w-1/2">
                        <label for="height" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_height">Your Height (cm)</label>
                        <input type="number" id="height" min="100" class="input-style" placeholder="e.g., 175" required>
                    </div>
                    <div class="w-1/2">
                        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_weight">Your Current Weight (kg)</label>
                        <input type="number" id="weight" min="40" class="input-style" placeholder="e.g., 75" required>
                    </div>
                </div>

                <div id="cycle-tracking-fields" class="hidden">
                    <div class="flex space-x-4 rtl:space-x-reverse">
                        <div class="w-1/2">
                            <label for="cycle_length" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_cycle_length">Average Cycle Length (Days)</label>
                            <input type="number" id="cycle_length" min="20" max="45" class="input-style" placeholder="e.g., 28">
                        </div>
                        <div class="w-1/2">
                            <label for="last_period_start" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_last_period">Last Period Start Date</label>
                            <input type="date" id="last_period_start" class="input-style">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="activity" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_activity">How Active Are You?</label>
                    <select id="activity" class="input-style" required>
                        <option value="1.2" data-translate-key="activity_1_2">Not Active (Desk job, little exercise)</option>
                        <option value="1.375" data-translate-key="activity_1_375">A Bit Active (Exercise 1-3 times a week)</option>
                        <option value="1.55" selected data-translate-key="activity_1_55">Active (Exercise 3-5 times a week)</option>
                        <option value="1.725" data-translate-key="activity_1_725">Very Active (Exercise 6-7 times a week)</option>
                        <option value="1.9" data-translate-key="activity_1_9">Extremely Active (Hard exercise + physical job)</option>
                    </select>
                </div>

                <hr class="border-gray-200 pt-2">

                <div class="flex space-x-4 rtl:space-x-reverse">
                    <div class="w-1/2">
                        <label for="goal_weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_goal_weight">How many kg do you want to lose?</label>
                        <input type="number" id="goal_weight" min="0.5" class="input-style" placeholder="e.g., 5" required>
                    </div>
                    <div class="w-1/2">
                        <label for="time_frame" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_time_frame">How many Weeks do you have?</label>
                        <input type="number" id="time_frame" min="1" class="input-style" placeholder="e.g., 8" required>
                    </div>
                </div>

                <button onclick="calculatePlan()" 
                    class="contact-btn w-full flex items-center justify-center px-8 py-4 text-lg font-semibold rounded-2xl shadow-xl text-white mt-6">
                    <span data-translate-key="btn_calculate">Find My Daily Calorie Goal</span>
                </button>
            </div>

            <div id="result-box" class="mt-8 p-6 result-box-style rounded-lg hidden">
                <h2 class="text-xl font-bold result-title-style mb-3" data-translate-key="result_title">Your Simple Plan</h2>
                
                <p class="text-gray-700 mb-3">
                    <span class="font-semibold" data-translate-key="result_maintenance">Calories to Stay the Same:</span> 
                    <span id="tdee-output"></span> kcal
                </p>

                <div class="result-inner-box p-4 rounded-md">
                    <p class="text-lg font-bold result-title-style" data-translate-key="result_daily_goal">Your Target Daily Calorie Goal is:</p>
                    <p class="text-4xl font-extrabold result-number-style mt-1"><span id="target-calories-output"></span> kcal</p>
                </div>
                
                <button onclick="saveCaloriePlan()" class="contact-btn w-full flex items-center justify-center px-4 py-3 text-base font-semibold rounded-xl shadow-lg text-white mt-4 transition-all duration-200">
                    <svg data-lucide="plus-circle" width="20" height="20" class="rtl-ml-2" aria-hidden="true"></svg>
                    <span data-translate-key="btn_add_to_plane">Add to Plan</span>
                </button>
                
                <p class="text-sm text-gray-600 mt-4">
                    <span data-translate-key="result_weekly_loss_info_part1">To reach your goal on time, you need to lose about </span>
                    <span id="weekly-loss-output" class="font-bold"></span> 
                    <span data-translate-key="result_weekly_loss_info_part2"> kg each week.</span>
                </p>
            </div>

            <div id="warning-box" class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg hidden">
                <p id="warning-message" class="text-sm font-medium text-yellow-800"></p>
            </div>
            
            <div id="limit-box" class="mt-4 p-4 bg-red-100 border-l-4 border-red-500 rounded-lg hidden">
                <p id="limit-message" class="text-sm font-medium text-red-800" data-translate-key="warning_plan_limit">
                    Limit reached: You can only save up to 3 plans. Please remove an old plan from the Plans page to save a new one.
                </p>
            </div>

        </div>
    </main>

    <footer class="p-6 bg-white border-t border-gray-100 shadow-inner">
        <p class="text-gray-600 text-center text-sm" data-translate-key="footer_text">&copy; 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi</p>
    </footer>

    <script>
        // --- GLOBAL STATE ---
        let currentLang = localStorage.getItem('malfitLang') || 'en';
        let userGender = localStorage.getItem('malfitGender') || 'male'; 

        // Constants for Calculation Logic
        const KCAL_PER_KG_FAT = 7700;
        const MIN_CALORIES_MALE = 1500;
        const MIN_CALORIES_FEMALE = 1200;
        const DAYS_IN_WEEK = 7;
        const CALORIE_SAVING_KEY = 'malfitCaloriePlans'; // Key for saving multiple plans
        // const PLAN_LIMIT = 3; // REMOVED: Limit is removed as requested.

        // --- GLOBAL VARIABLES TO STORE LAST RESULT ---
        let lastTdee = 0;
        let lastTargetCalories = 0;
        let lastGoalWeight = 0;
        let lastTimeFrameWeeks = 0;
        let lastGoalType = 'lose'; 
        // --------------------------------------------------

        // --- TRANSLATION DATA (FIXED AND COMPLETE) ---
        const translations = {
            'en': {
                'page_title': 'MALFIT | Calorie',
                'logo': 'MALFIT',
                'nav_calories': 'Calories',
                'nav_period': 'Period',
                'nav_eat_healthy': 'Eat Healthy',
                'nav_plans': 'Plans',
                'nav_clubs': 'Clubs',
                'nav_survey': 'Survey',
                'nav_contact_us': 'Contact Us',
                'footer_text': '© 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi',
                'lang_code': 'AR', 
                'label_cycle_length': 'Average Cycle Length (Days)',
                'label_last_period': 'Last Period Start Date',
                'calc_title': 'Calculate Calories',
                'calc_subtitle': 'Find your daily calorie target based on your goal.',
                'label_age': 'Your Age (Years)',
                'label_gender': 'Are you Male or Female?',
                'option_male': 'Male',
                'option_female': 'Female',
                'label_height': 'Your Height (cm)',
                'label_weight': 'Your Current Weight (kg)',
                'label_activity': 'How Active Are You?',
                'activity_1_2': 'Not Active (Desk job, little exercise)',
                'activity_1_375': 'A Bit Active (Exercise 1-3 times a week)',
                'activity_1_55': 'Active (Exercise 3-5 times a week)',
                'activity_1_725': 'Very Active (Exercise 6-7 times a week)',
                'activity_1_9': 'Extremely Active (Hard exercise + physical job)',
                'label_goal_weight': 'How many kg do you want to lose?',
                'label_time_frame': 'How many Weeks do you have?',
                'btn_calculate': 'Find My Daily Calorie Goal',
                'result_title': 'Your Simple Plan',
                'result_maintenance': 'Calories to Stay the Same:',
                'result_daily_goal': 'Your Target Daily Calorie Goal is:',
                'btn_add_to_plane': 'Add to Plan',
                'result_weekly_loss_info_part1': 'To reach your goal on time, you need to lose about ',
                'result_weekly_loss_info_part2': ' kg each week.',
                'warning_fill_fields': 'Please fill in all required fields to calculate your plan.',
                'warning_no_plan_to_save': 'Please calculate a plan first.',
                'warning_goal_too_fast': 'Warning: Goal too aggressive! To maintain health, we recommend a minimum of {safeMinimum} kcal/day. This will take about {resultingWeeks} weeks.',
                'warning_loss_fast': 'Warning: Losing weight this quickly can be challenging. We recommend consulting a professional.',
                'warning_error': 'Calculation Error: Using fallback target of {fallbackTarget} kcal.',
                'alert_plan_saved': 'Plan saved successfully! Redirecting to Plans page.',
                'warning_plan_limit': 'Limit reached: You can only save up to 3 plans. Please remove an old plan from the Plans page to save a new one.',
            },
            'ar': {
                'page_title': 'ملفت | السعرات الحرارية',
                'logo': 'ملفت',
                'nav_calories': 'السعرات الحرارية',
                'nav_period': 'الدورة الشهرية',
                'nav_eat_healthy': 'تناول طعام صحي',
                'nav_plans': 'الخطط',
                'nav_clubs': 'الأندية',
                'nav_survey': 'الاستبيان',
                'nav_contact_us': 'اتصل بنا',
                'footer_text': '© 2025، مشروع تخرج، مدى صالح، أحمد خليفة، لورا عادل، المشرف الدكتور عبد الله محمد خالد القادومي',
                'lang_code': 'EN', 
                'label_cycle_length': 'متوسط طول الدورة (بالأيام)',
                'label_last_period': 'تاريخ بدء آخر دورة',
                'calc_title': 'حساب السعرات الحرارية',
                'calc_subtitle': 'اعثر على هدفك اليومي من السعرات الحرارية بناءً على هدفك.',
                'label_age': 'عمرك (بالسنوات)',
                'label_gender': 'هل أنت ذكر أم أنثى؟',
                'option_male': 'ذكر',
                'option_female': 'أنثى',
                'label_height': 'طولك (بالسنتيمتر)',
                'label_weight': 'وزنك الحالي (بالكيلوجرام)',
                'label_activity': 'ما مدى نشاطك؟',
                'activity_1_2': 'غير نشط (عمل مكتبي، قليل من الرياضة)',
                'activity_1_375': 'نشط قليلاً (رياضة 1-3 مرات في الأسبوع)',
                'activity_1_55': 'نشط (رياضة 3-5 مرات في الأسبوع)',
                'activity_1_725': 'نشط جداً (رياضة 6-7 مرات في الأسبوع)',
                'activity_1_9': 'نشط للغاية (رياضة شاقة + وظيفة تتطلب جهداً بدنياً)',
                'label_goal_weight': 'كم كيلوغراماً تريد أن تخسر؟',
                'label_time_frame': 'كم أسبوعاً لديك؟',
                'btn_calculate': 'اكتشف هدفي اليومي من السعرات', 
                'result_title': 'خطتك البسيطة',
                'result_maintenance': 'السعرات الحرارية للحفاظ على الوزن:',
                'result_daily_goal': 'هدف السعرات اليومي المستهدف هو:',
                'btn_add_to_plane': 'أضف إلى الخطة',
                'result_weekly_loss_info_part1': 'للوصول إلى هدفك في الوقت المحدد، تحتاج إلى خسارة حوالي ',
                'result_weekly_loss_info_part2': ' كجم كل أسبوع.',
                'warning_fill_fields': 'الرجاء ملء جميع الحقول المطلوبة لحساب خطتك.',
                'warning_no_plan_to_save': 'الرجاء حساب الخطة أولاً.',
                'warning_goal_too_fast': 'تحذير: الهدف مفرط في السرعة! للحفاظ على الصحة، نوصي بحد أدنى {safeMinimum} سعرة حرارية/يوم. سيستغرق هذا حوالي {resultingWeeks} أسابيع.',
                'warning_loss_fast': 'تحذير: خسارة الوزن بهذه السرعة قد تكون صعبة. نوصي باستشارة مختص.',
                'warning_error': 'خطأ في الحساب: سيتم استخدام الهدف الافتراضي {fallbackTarget} سعرة حرارية.',
                'alert_plan_saved': 'تم حفظ الخطة بنجاح! سيتم إعادة توجيهك إلى صفحة الخطط.',
                'warning_plan_limit': 'تم الوصول إلى الحد الأقصى: يمكنك حفظ 3 خطط كحد أقصى فقط. يرجى إزالة خطة قديمة من صفحة الخطط لحفظ خطة جديدة.',
            }
        };

        // --- UTILITY FUNCTIONS ---

        /**
         * Clears and optionally displays a warning message in the yellow box.
         * @param {string} [messageKey] - The translation key for the message.
         * @param {Object} [replacements] - Key-value pairs for string replacement in the warning.
         */
        function displayWarning(messageKey, replacements = {}) {
            const warningBox = document.getElementById('warning-box');
            const warningMessage = document.getElementById('warning-message');

            warningBox.classList.add('hidden');
            warningMessage.textContent = '';
            
            if (messageKey) {
                let message = translations[currentLang][messageKey] || messageKey;
                
                // Apply replacements
                for (const key in replacements) {
                    const regex = new RegExp(`{${key}}`, 'g');
                    message = message.replace(regex, replacements[key]);
                }

                warningMessage.textContent = message;
                warningBox.classList.remove('hidden');
            }
        }
        
        /**
         * Displays a warning in the RED limit box (now unused for limit checking).
         */
        function displayLimitWarning(show) {
            const limitBox = document.getElementById('limit-box');
            if (show) {
                limitBox.classList.remove('hidden');
            } else {
                limitBox.classList.add('hidden');
            }
        }

        // --- LIFECYCLE & THEME/LANG FUNCTIONS ---

        /**
         * Toggles visibility of the cycle tracking fields in the form and the 'Period' links in the navigation based on the currently selected gender.
         */
        function toggleCycleTrackingFields() {
            const genderSelect = document.getElementById('gender');
            const cycleFields = document.getElementById('cycle-tracking-fields');
            const isFemale = genderSelect.value === 'female';
            
            // Toggle visibility of the form fields
            if (isFemale) {
                cycleFields.classList.remove('hidden');
            } else {
                cycleFields.classList.add('hidden');
            }
            // Note: Visibility of the Period links in the nav is handled by CSS/updateTheme.
        }

        /**
         * Toggles the mobile navigation menu.
         */
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('active');
        }

        /**
         * Updates the theme (colors) based on the selected gender.
         * @param {string} gender - 'male' or 'female'.
         * @param {boolean} [save=true] - Whether to save the preference to localStorage.
         */
        function updateTheme(gender, save = true) {
            const html = document.documentElement;
            if (gender === 'female') {
                html.classList.add('female-theme');
            } else {
                html.classList.remove('female-theme');
            }
            if (save) {
                localStorage.setItem('malfitGender', gender);
                userGender = gender;
            }
        }

        /**
         * Loads saved user preferences (like gender) and applies them on page load.
         */
        window.loadUserPreferences = function() {
            // 1. Load Gender from localStorage
            const savedGender = localStorage.getItem('malfitGender');
            if (savedGender) {
                userGender = savedGender;
                // Set the calculator's gender selection to the saved value
                const genderSelect = document.getElementById('gender');
                if (genderSelect) {
                    genderSelect.value = userGender;
                }
            }
            
            // 2. Apply theme based on loaded gender (don't save again on load)
            updateTheme(userGender, false); 
            
            // 3. Ensure cycle fields are correctly toggled based on the saved gender
            toggleCycleTrackingFields(); 

            // 4. Apply initial translations
            applyTranslations();
        }

        /**
         * Applies the translations based on the currentLang setting.
         */
        function applyTranslations() {
            // Update the HTML direction attribute
            const html = document.documentElement;
            const newDir = currentLang === 'ar' ? 'rtl' : 'ltr';
            html.setAttribute('lang', currentLang);
            html.setAttribute('dir', newDir);
            
            // Update all elements with a translation key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = translations[currentLang][key];
                
                if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                    element.setAttribute('placeholder', translation || element.getAttribute('placeholder'));
                } else if (element.tagName === 'OPTION') {
                    element.textContent = translation || element.textContent;
                } else if (element.tagName === 'TITLE') {
                    document.title = translation || element.textContent;
                } else if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update the language toggle button text
            document.getElementById('current-lang').textContent = translations[currentLang].lang_code;
            
            // Re-create Lucide icons after translation
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
            // Hide the obsolete limit warning
            displayLimitWarning(false);
        }

        /**
         * Toggles the language and re-applies translations.
         */
        window.toggleLanguage = function() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('malfitLang', currentLang);
            applyTranslations();
            // Close mobile menu on language switch for better UX
            document.getElementById('mobile-menu').classList.remove('active');
        }

        // --- CORE CALCULATION LOGIC ---

        /**
         * Calculates BMR using the Harris-Benedict formula (adjusted/simplified for common use).
         * Male BMR: 66 + (13.7 × weight in kg) + (5 × height in cm) – (6.8 × age in years)
         * Female BMR: 655 + (9.6 × weight in kg) + (1.8 × height in cm) – (4.7 × age in years)
         * @returns {number} BMR in kcal/day.
         */
        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 66 + (13.7 * weight) + (5 * height) - (6.8 * age);
            } else { // female
                return 655 + (9.6 * weight) + (1.8 * height) - (4.7 * age);
            }
        }

        /**
         * Calculates the total daily energy expenditure (TDEE).
         * @returns {number} TDEE in kcal/day.
         */
        function calculateTDEE(bmr, activityMultiplier) {
            return bmr * activityMultiplier;
        }


        /**
         * Calculates the required daily calorie goal to achieve the weight loss target.
         */
        window.calculatePlan = function() {
            // 1. Reset
            document.getElementById('result-box').classList.add('hidden');
            displayWarning(null); // Clear previous warnings
            
            // 2. Get Inputs
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityMultiplier = parseFloat(document.getElementById('activity').value);
            const goalWeight = parseFloat(document.getElementById('goal_weight').value);
            const timeFrameWeeks = parseFloat(document.getElementById('time_frame').value);

            // 3. Validation
            if (!age || !height || !weight || !goalWeight || !timeFrameWeeks || age <= 0 || height <= 0 || weight <= 0 || goalWeight <= 0 || timeFrameWeeks <= 0) {
                displayWarning('warning_fill_fields');
                return;
            }

            try {
                // 4. Core Calculation
                const bmr = calculateBMR(weight, height, age, gender);
                const tdee = calculateTDEE(bmr, activityMultiplier);

                // Total calorie deficit needed: Goal weight (kg) * KCAL_PER_KG_FAT
                const totalCalorieDeficit = goalWeight * KCAL_PER_KG_FAT;
                
                // Total days in the time frame
                const totalDays = timeFrameWeeks * DAYS_IN_WEEK;
                
                // Daily calorie deficit needed: Total Calorie Deficit / Total Days
                const dailyCalorieDeficit = totalCalorieDeficit / totalDays;
                
                // Target daily calories: TDEE - Daily Deficit
                let targetCalories = tdee - dailyCalorieDeficit;

                const safeMinimum = (gender === 'male') ? MIN_CALORIES_MALE : MIN_CALORIES_FEMALE;
                
                // 5. Safety and Warning Check
                if (targetCalories < safeMinimum) {
                    // Recalculate time if aiming for the safe minimum
                    const safeDailyDeficit = tdee - safeMinimum;
                    const safeTimeWeeks = Math.ceil(totalCalorieDeficit / safeDailyDeficit / DAYS_IN_WEEK);
                    
                    displayWarning('warning_goal_too_fast', {
                        safeMinimum: safeMinimum.toLocaleString(),
                        resultingWeeks: safeTimeWeeks
                    });
                    
                    // Set target to the safe minimum limit
                    targetCalories = safeMinimum;

                } else if (dailyCalorieDeficit > 1000) { // Warning if deficit is too large (over 1kg/week loss)
                    displayWarning('warning_loss_fast');
                }

                // 6. Update Global State
                lastTdee = Math.round(tdee);
                lastTargetCalories = Math.round(targetCalories);
                lastGoalWeight = goalWeight;
                lastTimeFrameWeeks = timeFrameWeeks;
                lastGoalType = 'lose'; // Fixed to 'lose' since the form only calculates loss.

                // 7. Display Results
                const weeklyLoss = (dailyCalorieDeficit * DAYS_IN_WEEK / KCAL_PER_KG_FAT).toFixed(2);
                
                document.getElementById('tdee-output').textContent = lastTdee.toLocaleString();
                document.getElementById('target-calories-output').textContent = lastTargetCalories.toLocaleString();
                document.getElementById('weekly-loss-output').textContent = weeklyLoss;
                document.getElementById('result-box').classList.remove('hidden');

            } catch (e) {
                console.error("Calculation failed:", e);
                // Fallback in case of unexpected error
                const fallbackTarget = (gender === 'male') ? 2000 : 1600;
                lastTargetCalories = fallbackTarget;
                displayWarning('warning_error', { fallbackTarget: fallbackTarget.toLocaleString() });
            }
        }


        /**
         * Saves the calculated plan to local storage and redirects to the Plans page.
         */
        window.saveCaloriePlan = function() {
            if (lastTargetCalories === 0) {
                displayWarning('warning_no_plan_to_save');
                return;
            }
            
            // Get existing plans or initialize an empty array
            const existingPlans = JSON.parse(localStorage.getItem(CALORIE_SAVING_KEY) || '[]');
            
            const newPlan = {
                id: Date.now(), // Unique ID for keying/deleting
                type: lastGoalType,
                target: lastTargetCalories,
                tdee: lastTdee,
                goalWeight: lastGoalWeight,
                timeFrameWeeks: lastTimeFrameWeeks,
                gender: userGender,
                date: new Date().toISOString() // Save the current timestamp
            };

            // Add the new plan
            existingPlans.push(newPlan);
            
            // Save back to localStorage
            localStorage.setItem(CALORIE_SAVING_KEY, JSON.stringify(existingPlans));
            
            // Alert and Redirect
            alert(translations[currentLang].alert_plan_saved);
            window.location.href = '../Plans/plans.html';
        }
    </script>
</body>
</html>
