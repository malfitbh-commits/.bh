<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="page_title">MALFIT | Calorie</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script> 

    <style>
        /* Custom styles from the previous file */
        :root {
            --primary-color: #4f46e5; /* Default: indigo-600 */
            --primary-light: #eef2ff; /* Default: indigo-50 */
            --logo-color: #4f46e5;
            --calc-gradient-start: #4f46e5; /* Indigo */
            --calc-gradient-end: #3b82f6; /* Blue */
            --result-text-color: #3730a3; /* Indigo-800 */
            --result-highlight-color: #4338ca; /* Indigo-700 */
        }
        
        /* --- START: FEMALE THEME OVERRIDE --- */
        .female-theme {
            --primary-color: #ec4899; /* Pink-600 */
            --primary-light: #fdf2f8; /* Pink-50 */
            --logo-color: #ec4899;
            --calc-gradient-start: #ec4899; /* Pink */
            --calc-gradient-end: #f43f5e; /* Rose */
            --result-text-color: #9d174d; /* Pink-800 */
            --result-highlight-color: #be185d; /* Pink-700 */
        }
        
        /* Hide Period link until Female theme is active */
        .hidden-until-female {
            display: none !important;
        }
        /* --- END: FEMALE THEME OVERRIDE --- */


        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* Softer, slightly blue background */
            overflow-x: hidden; 
            min-height: 100vh;
            position: relative; 
        }

        /* Apply Arabic font when direction is RTL */
        html[dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }
        
        /* * === NEW: FALLING ITEM STYLES === 
        * Required for the background animation script
        */
        .falling-item {
            position: absolute;
            user-select: none;
            pointer-events: none; 
            opacity: 0.3; /* Subtle transparency */
            transition: opacity 2s ease-out;
            z-index: 0; 
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.1); 
        }
        
        /* Ensure the header, main content, and footer are above the falling background */
        header, main, footer {
            position: relative;
            z-index: 10; 
        }
        
        /* --- Custom Nav Link Styles (Pill-shaped) --- */
        .nav-link {
            text-decoration: none;
            color: #474646;
            font-weight: 500;
            padding: 10px 15px; 
            margin-right: 10px;
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
            border-radius: 9999px; /* Pill shape */
            white-space: nowrap;
        }
        /* Highlight the active link for this page */
        .nav-link.active-calorie {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            font-weight: 700;
        }
        .nav-link:hover {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            transform: translateY(-1px);
        }
        
        /* Adjustments for RTL layout for links */
        html[dir="rtl"] header nav .nav-link {
            margin-right: 0;
            margin-left: 10px;
        }
        
        /* --- Header Specific Styles --- */
        header {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Stronger header shadow */
            background-color: #ffffff;
            transition: box-shadow 0.3s ease-in-out;
        }
        
        /* --- Mobile Menu Styles (Using existing Tailwind classes for responsiveness) --- */
        #mobile-menu {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            background-color: #ffffff;
            position: absolute;
            top: 70px; 
            right: 0;
            left: 0;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        #mobile-menu.active {
            max-height: 500px;
            opacity: 1;
            padding: 10px 0;
        }
        #mobile-menu a {
            display: block;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            color: #333;
            text-decoration: none;
            text-align: left; 
            transition: background-color 0.15s;
        }
        #mobile-menu a:hover {
            background-color: var(--primary-light);
        }
        html[dir="rtl"] #mobile-menu a {
            text-align: right; 
        }

        /* Icon Button Styling */
        .icon-btn {
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-700 */
        }
        .icon-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        /* Specific RTL fix for button icon placement (mr-2 equivalent for RTL) */
        .rtl-ml-2 {
            margin-right: 0.5rem; 
        }
        html[dir="rtl"] .rtl-ml-2 {
            margin-right: 0;
            margin-left: 0.5rem; 
        }
        
        /* Enhanced Contact Button Gradient - Uses CSS variables */
        .contact-btn {
            background-image: linear-gradient(to right, var(--calc-gradient-start) 0%, var(--calc-gradient-end) 100%); 
            transition: all 0.2s ease;
        }
        .contact-btn:hover {
            box-shadow: 0 8px 15px rgba(63, 131, 248, 0.4); /* General shadow for hover effect */
            transform: scale(1.02);
            opacity: 0.95;
        }
        
        /* Centering for the main card container */
        .min-h-main {
            min-height: calc(100vh - 140px);
        }
        @media (min-width: 768px) {
            .min-h-main {
                min-height: calc(100vh - 120px); 
            }
        }

        /* Calculator Specific Styles */
        .input-style {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
            color: #1f2937;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--primary-color); /* Uses CSS Variable */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .result-box-style {
            background-color: var(--primary-light); /* Uses CSS Variable */
            border-left: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
        html[dir="rtl"] .result-box-style {
            border-left: none;
            border-right: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
        
        /* Result Box inner content styling using CSS variables */
        .result-inner-box {
             background-color: var(--primary-light);
        }
        .result-title-style {
            color: var(--result-text-color);
        }
        .result-number-style {
            color: var(--result-highlight-color);
        }
    </style>
</head>
<body>
    
    <header class="sticky top-0 z-50 w-full flex items-center justify-between px-4 md:px-8 lg:px-16 py-3 bg-white border-b border-gray-100">
        
        <div class="flex items-center">
            <a href="../Home/home.html" id="logo" class="text-3xl font-extrabold text-indigo-600 tracking-wide" data-translate-key="logo" aria-label="Go to Homepage">MALFIT</a>
        </div>

        <nav class="hidden md:flex flex-grow justify-center mx-10">
            <a href="Calories.html" class="nav-link active-calorie" data-translate-key="nav_calories">Calories</a>
            <a href="../Period/period.html" id="nav-period-desktop" class="nav-link hidden-until-female" data-translate-key="nav_period">Period</a>
            <a href="../Eat healthy/eat healthy.html" class="nav-link" data-translate-key="nav_eat_healthy">Eat Healthy</a>
            <a href="../Plans/plans.html" class="nav-link" data-translate-key="nav_plans">Plans</a>
            <a href="../Clubs/clubs.html" class="nav-link" data-translate-key="nav_clubs">Clubs</a>
            <a href="../Survey/survey.html" class="nav-link" data-translate-key="nav_survey">Survey</a>
            <a href="../Contact us/contact us.html" class="nav-link" data-translate-key="nav_contact_us">Contact Us</a>
        </nav>

        <div class="icons-container flex items-center gap-2 md:gap-4">
            
            <button id="lang-toggle" class="icon-btn w-10 h-10 border-2 border-gray-300 hover:border-indigo-600" aria-label="Toggle language">
                <span id="current-lang" class="text-sm font-bold">EN</span> 
            </button>

            <a href="../Home/home.html" class="icon-btn hover:bg-indigo-50" aria-label="Home">
                <svg data-lucide="home" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <a href="../Account/account.html" class="icon-btn hover:bg-indigo-50" aria-label="Account Settings">
                <svg data-lucide="user" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <button id="menu-toggle" class="md:hidden icon-btn" aria-label="Toggle mobile menu">
                <svg data-lucide="menu" width="24" height="24" aria-hidden="true"></svg>
            </button>
        </div>
    </header>

    <div id="mobile-menu" class="md:hidden">
        <a href="calories.html" data-translate-key="nav_calories">Calories</a>
        <a href="../Period/period.html" id="nav-period-mobile" class="hidden-until-female" data-translate-key="nav_period">Period</a>
        <a href="../Eat healthy/eat healthy.html" data-translate-key="nav_eat_healthy">Eat Healthy</a>
        <a href="../Plans/plans.html" data-translate-key="nav_plans">Plans</a>
        <a href="../Clubs/clubs.html" data-translate-key="nav_clubs">Clubs</a>
        <a href="../Survey/survey.html" data-translate-key="nav_survey">Survey</a>
        <a href="../Contact us/contact us.html" data-translate-key="nav_contact_us">Contact Us</a>
    </div>

    <main class="flex items-center justify-center p-4 min-h-main"> 
    
        <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 sm:p-8 border border-blue-50/50 transform transition-all duration-300 hover:shadow-indigo-200/50">

            <div class="text-center">
                <div id="calculator-icon-container" class="mx-auto w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                    <svg data-lucide="calculator" width="28" height="28" stroke="white" stroke-width="2.5" aria-hidden="true"></svg>
                </div>
                <h1 class="mt-6 text-3xl font-extrabold text-gray-900 leading-tight" data-translate-key="calc_title">Calculate Calories</h1>
                <p class="mt-3 text-md text-gray-500 max-w-md mx-auto" data-translate-key="calc_subtitle">Find your daily calorie target based on your goal.</p>
            </div>

            <div class="space-y-4 mt-8">
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_age">Your Age (Years)</label>
                        <input type="number" id="age" min="15" class="input-style" placeholder="e.g., 30">
                    </div>
                    <div class="w-1/2">
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_gender">Are you Male or Female?</label>
                        <select id="gender" class="input-style" onchange="updateTheme(this.value); toggleCycleTrackingFields();">
                            <option value="male" data-translate-key="option_male">Male</option>
                            <option value="female" data-translate-key="option_female">Female</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="height" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_height">Your Height (cm)</label>
                        <input type="number" id="height" min="100" class="input-style" placeholder="e.g., 175">
                    </div>
                    <div class="w-1/2">
                        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_weight">Your Current Weight (kg)</label>
                        <input type="number" id="weight" min="40" class="input-style" placeholder="e.g., 75">
                    </div>
                </div>

                <div id="cycle-tracking-fields" class="hidden">
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="cycle_length" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_cycle_length">Average Cycle Length (Days)</label>
                            <input type="number" id="cycle_length" min="20" max="45" class="input-style" placeholder="e.g., 28">
                        </div>
                        <div class="w-1/2">
                            <label for="last_period_start" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_last_period">Last Period Start Date</label>
                            <input type="date" id="last_period_start" class="input-style">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="activity" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_activity">How Active Are You?</label>
                    <select id="activity" class="input-style">
                        <option value="1.2" data-translate-key="activity_1_2">Not Active (Desk job, little exercise)</option>
                        <option value="1.375" data-translate-key="activity_1_375">A Bit Active (Exercise 1-3 times a week)</option>
                        <option value="1.55" selected data-translate-key="activity_1_55">Active (Exercise 3-5 times a week)</option>
                        <option value="1.725" data-translate-key="activity_1_725">Very Active (Exercise 6-7 times a week)</option>
                        <option value="1.9" data-translate-key="activity_1_9">Extremely Active (Hard exercise + physical job)</option>
                    </select>
                </div>

                <hr class="border-gray-200 pt-2">

                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="goal_weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_goal_weight">How many kg do you want to lose?</label>
                        <input type="number" id="goal_weight" min="0.5" class="input-style" placeholder="e.g., 5">
                    </div>
                    <div class="w-1/2">
                        <label for="time_frame" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_time_frame">How many Weeks do you have?</label>
                        <input type="number" id="time_frame" min="1" class="input-style" placeholder="e.g., 8">
                    </div>
                </div>

                <button onclick="calculatePlan()" 
                    class="contact-btn w-full flex items-center justify-center px-8 py-4 text-lg font-semibold rounded-2xl shadow-xl text-white mt-6">
                    <span data-translate-key="btn_calculate">Find My Daily Calorie Goal</span>
                </button>
            </div>

            <div id="result-box" class="mt-8 p-6 result-box-style rounded-lg hidden">
                <h2 class="text-xl font-bold result-title-style mb-3" data-translate-key="result_title">Your Simple Plan</h2>
                
                <p class="text-gray-700 mb-3">
                    <span class="font-semibold" data-translate-key="result_maintenance">Calories to Stay the Same:</span> 
                    <span id="tdee-output"></span> kcal
                </p>

                <div class="result-inner-box p-4 rounded-md">
                    <p class="text-lg font-bold result-title-style" data-translate-key="result_daily_goal">Your Target Daily Calorie Goal is:</p>
                    <p class="text-4xl font-extrabold result-number-style mt-1"><span id="target-calories-output"></span> kcal</p>
                </div>
                
                <button onclick="saveCaloriePlan()" class="contact-btn w-full flex items-center justify-center px-4 py-3 text-base font-semibold rounded-xl shadow-lg text-white mt-4 transition-all duration-200">
                    <svg data-lucide="plus-circle" width="20" height="20" class="rtl-ml-2" aria-hidden="true"></svg>
                    <span data-translate-key="btn_add_to_plane">Add to Plan</span>
                </button>
                
                <p class="text-sm text-gray-600 mt-4">
                    <span data-translate-key="result_weekly_loss_info_part1">To reach your goal on time, you need to lose about </span>
                    <span id="weekly-loss-output" class="font-bold"></span> 
                    <span data-translate-key="result_weekly_loss_info_part2"> kg each week.</span>
                </p>
            </div>

            <div id="warning-box" class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg hidden">
                <p id="warning-message" class="text-sm font-medium text-yellow-800"></p>
            </div>

        </div>
    </main>

    <footer class="p-6 bg-white border-t border-gray-100 shadow-inner">
        <p class="text-gray-600 text-center text-sm" data-translate-key="footer_text">&copy; 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi</p>
    </footer>

    <script>
        // --- GLOBAL STATE ---
        let currentLang = localStorage.getItem('malfitLang') || 'en';
        let userGender = localStorage.getItem('malfitGender') || 'male'; 

        // Constants for Calculation Logic
        const KCAL_PER_KG_FAT = 7700;
        const MIN_CALORIES_MALE = 1500;
        const MIN_CALORIES_FEMALE = 1200;
        const DAYS_IN_WEEK = 7;

        // --- GLOBAL VARIABLES TO STORE LAST RESULT ---
        let lastTdee = 0;
        let lastTargetCalories = 0;
        let lastGoalWeight = 0;
        let lastTimeFrameWeeks = 0;
        let lastGoalType = 'lose'; 
        // --------------------------------------------------

        // --- TRANSLATION DATA (FIXED AND COMPLETE) ---
        const translations = {
            'en': {
                'page_title': 'MALFIT | Calorie',
                'logo': 'MALFIT',
                'nav_calories': 'Calories',
                'nav_period': 'Period',
                'nav_eat_healthy': 'Eat Healthy',
                'nav_plans': 'Plans',
                'nav_clubs': 'Clubs',
                'nav_survey': 'Survey',
                'nav_contact_us': 'Contact Us',
                'footer_text': 'Â© 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi',
                'lang_code': 'AR', 

                'label_cycle_length': 'Average Cycle Length (Days)',
                'label_last_period': 'Last Period Start Date',

                'calc_title': 'Calculate Calories',
                'calc_subtitle': 'Find your daily calorie target based on your goal.',
                'label_age': 'Your Age (Years)',
                'label_gender': 'Are you Male or Female?',
                'option_male': 'Male',
                'option_female': 'Female',
                'label_height': 'Your Height (cm)',
                'label_weight': 'Your Current Weight (kg)',
                'label_activity': 'How Active Are You?',
                'activity_1_2': 'Not Active (Desk job, little exercise)',
                'activity_1_375': 'A Bit Active (Exercise 1-3 times a week)',
                'activity_1_55': 'Active (Exercise 3-5 times a week)',
                'activity_1_725': 'Very Active (Exercise 6-7 times a week)',
                'activity_1_9': 'Extremely Active (Hard exercise + physical job)',
                'label_goal_weight': 'How many kg do you want to lose?',
                'label_time_frame': 'How many Weeks do you have?',
                'btn_calculate': 'Find My Daily Calorie Goal',
                
                'result_title': 'Your Simple Plan',
                'result_maintenance': 'Calories to Stay the Same:',
                'result_daily_goal': 'Your Target Daily Calorie Goal is:',
                'btn_add_to_plane': 'Add to Plan',
                'result_weekly_loss_info_part1': 'To reach your goal on time, you need to lose about ',
                'result_weekly_loss_info_part2': ' kg each week.',
                
                'warning_fill_fields': 'Please fill in all required fields to calculate your plan.',
                'warning_no_plan_to_save': 'Please calculate a plan first.',
                'warning_goal_too_fast': 'Warning: Goal too aggressive! To maintain health, we recommend a minimum of {safeMinimum} kcal/day. This will take about {resultingWeeks} weeks.',
                'warning_loss_fast': 'Warning: Losing weight this quickly can be challenging. We recommend consulting a professional.',
                'warning_error': 'Calculation Error: Using fallback target of {fallbackTarget} kcal.',
                'alert_plan_saved': 'Plan saved successfully! Redirecting to Plans page.',
            },
            'ar': {
                'page_title': 'Ù…Ù„ÙØª | Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©',
                'logo': 'Ù…Ù„ÙØª',
                'nav_calories': 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©',
                'nav_period': 'Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                'nav_eat_healthy': 'ØªÙ†Ø§ÙˆÙ„ Ø·Ø¹Ø§Ù… ØµØ­ÙŠ',
                'nav_plans': 'Ø§Ù„Ø®Ø·Ø·',
                'nav_clubs': 'Ø§Ù„Ø£Ù†Ø¯ÙŠØ©',
                'nav_survey': 'Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†',
                'nav_contact_us': 'Ø§ØªØµÙ„ Ø¨Ù†Ø§',
                'footer_text': 'Â© 2025ØŒ Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ØŒ Ù…Ø¯Ù‰ ØµØ§Ù„Ø­ØŒ Ø£Ø­Ù…Ø¯ Ø®Ù„ÙŠÙØ©ØŒ Ù„ÙˆØ±Ø§ Ø¹Ø§Ø¯Ù„ØŒ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯ Ø§Ù„Ù‚Ø§Ø¯ÙˆÙ…ÙŠ',
                'lang_code': 'EN', 
                
                'label_cycle_length': 'Ù…ØªÙˆØ³Ø· Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)',
                'label_last_period': 'ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø¢Ø®Ø± Ø¯ÙˆØ±Ø©',

                'calc_title': 'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©',
                'calc_subtitle': 'Ø§Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù‡Ø¯ÙÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø¯ÙÙƒ.',
                'label_age': 'Ø¹Ù…Ø±Ùƒ (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª)',
                'label_gender': 'Ù‡Ù„ Ø£Ù†Øª Ø°ÙƒØ± Ø£Ù… Ø£Ù†Ø«Ù‰ØŸ',
                'option_male': 'Ø°ÙƒØ±',
                'option_female': 'Ø£Ù†Ø«Ù‰',
                'label_height': 'Ø·ÙˆÙ„Ùƒ (Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±)',
                'label_weight': 'ÙˆØ²Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØ¬Ø±Ø§Ù…)',
                'label_activity': 'Ù…Ø§ Ù…Ø¯Ù‰ Ù†Ø´Ø§Ø·ÙƒØŸ',
                'activity_1_2': 'ØºÙŠØ± Ù†Ø´Ø· (Ø¹Ù…Ù„ Ù…ÙƒØªØ¨ÙŠØŒ Ù‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø±ÙŠØ§Ø¶Ø©)',
                'activity_1_375': 'Ù†Ø´Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Ø±ÙŠØ§Ø¶Ø© 1-3 Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)',
                'activity_1_55': 'Ù†Ø´Ø· (Ø±ÙŠØ§Ø¶Ø© 3-5 Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)',
                'activity_1_725': 'Ù†Ø´Ø· Ø¬Ø¯Ø§Ù‹ (Ø±ÙŠØ§Ø¶Ø© 6-7 Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)',
                'activity_1_9': 'Ù†Ø´Ø· Ù„Ù„ØºØ§ÙŠØ© (Ø±ÙŠØ§Ø¶Ø© Ø´Ø§Ù‚Ø© + ÙˆØ¸ÙŠÙØ© ØªØªØ·Ù„Ø¨ Ø¬Ù‡Ø¯Ø§Ù‹ Ø¨Ø¯Ù†ÙŠØ§Ù‹)',
                'label_goal_weight': 'ÙƒÙ… ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…Ø§Ù‹ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ®Ø³Ø±ØŸ',
                'label_time_frame': 'ÙƒÙ… Ø£Ø³Ø¨ÙˆØ¹Ø§Ù‹ Ù„Ø¯ÙŠÙƒØŸ',
                'btn_calculate': 'Ø§ÙƒØªØ´Ù Ù‡Ø¯ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª', 
                
                'result_title': 'Ø®Ø·ØªÙƒ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©',
                'result_maintenance': 'Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ²Ù†:',
                'result_daily_goal': 'Ù‡Ø¯Ù Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù‡Ùˆ:',
                'btn_add_to_plane': 'Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·Ø©',
                'result_weekly_loss_info_part1': 'Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø¯ÙÙƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø®Ø³Ø§Ø±Ø© Ø­ÙˆØ§Ù„ÙŠ ',
                'result_weekly_loss_info_part2': ' ÙƒØ¬Ù… ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹.',
                
                'warning_fill_fields': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø­Ø³Ø§Ø¨ Ø®Ø·ØªÙƒ.',
                'warning_no_plan_to_save': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹.',
                'warning_goal_too_fast': 'ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù‡Ø¯Ù Ù…ÙØ±Ø· ÙÙŠ Ø§Ù„Ø³Ø±Ø¹Ø©! Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØµØ­Ø©ØŒ Ù†ÙˆØµÙŠ Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ {safeMinimum} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©/ÙŠÙˆÙ…. Ø³ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø­ÙˆØ§Ù„ÙŠ {resultingWeeks} Ø£Ø³Ø§Ø¨ÙŠØ¹.',
                'warning_loss_fast': 'ØªØ­Ø°ÙŠØ±: Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙˆØ²Ù† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø±Ø¹Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† ØµØ¹Ø¨Ø©. Ù†ÙˆØµÙŠ Ø¨Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø®ØªØµ.',
                'warning_error': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨: Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ {fallbackTarget} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©.',
                'alert_plan_saved': 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø®Ø·Ø·.',
            }
        };

        // --- CORE CALCULATION FUNCTIONS (Moved out of calculatePlan for clarity) ---

        /**
         * Calculates Basal Metabolic Rate (BMR) using the Mifflin-St Jeor equation.
         * @param {number} weightKg - Weight in kilograms.
         * @param {number} heightCm - Height in centimeters.
         * @param {number} age - Age in years.
         * @param {string} gender - 'male' or 'female'.
         * @returns {number} The estimated BMR in kcal/day.
         */
        function calculateBMR(weightKg, heightCm, age, gender) {
            let bmr;
            if (gender === 'male') {
                // BMR = (10 * weight in kg) + (6.25 * height in cm) - (5 * age in years) + 5
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else { // female
                // BMR = (10 * weight in kg) + (6.25 * height in cm) - (5 * age in years) - 161
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }
            return bmr;
        }

        /**
         * Calculates Total Daily Energy Expenditure (TDEE).
         * @param {number} bmr - Basal Metabolic Rate (kcal/day).
         * @param {number} activityFactor - Activity multiplier (e.g., 1.55).
         * @returns {number} The estimated TDEE in kcal/day.
         */
        function calculateTDEE(bmr, activityFactor) {
            return bmr * activityFactor;
        }

        // --- UTILITY FUNCTIONS ---

        /**
         * Clears and optionally displays a warning message.
         * @param {string} [messageKey] - The translation key for the message.
         * @param {Object} [replacements] - Key-value pairs for string replacement in the warning.
         */
        function displayWarning(messageKey, replacements = {}) {
            const warningBox = document.getElementById('warning-box');
            const warningMessage = document.getElementById('warning-message');

            warningBox.classList.add('hidden');
            warningMessage.textContent = '';
            
            if (messageKey) {
                let message = translations[currentLang][messageKey] || messageKey;
                
                // Apply replacements
                for (const key in replacements) {
                    const regex = new RegExp(`{${key}}`, 'g');
                    message = message.replace(regex, replacements[key]);
                }

                warningMessage.textContent = message;
                warningBox.classList.remove('hidden');
            }
        }


        // --- LIFECYCLE & THEME/LANG FUNCTIONS ---

        /**
         * Applies the female theme by adding the class and setting the local storage.
         * @param {string} gender - 'male' or 'female'.
         * @param {boolean} [save=true] - Whether to save the preference to local storage.
         */
        function updateTheme(gender, save = true) {
            const body = document.body;
            const logo = document.getElementById('logo');

            if (gender === 'female') {
                body.classList.add('female-theme');
                // Temporarily update logo color based on gender for theme application
                logo.style.color = '#ec4899'; // Pink-600
            } else {
                body.classList.remove('female-theme');
                // Reset logo color to default
                logo.style.color = '#4f46e5'; // Indigo-600
            }
            
            if (save) {
                userGender = gender;
                localStorage.setItem('malfitGender', gender);
            }
        }

        /**
         * Loads saved user preferences (like gender) and applies them on page load.
         */
        function loadUserPreferences() {
            // 1. Load Gender from localStorage
            const savedGender = localStorage.getItem('malfitGender');
            if (savedGender) {
                userGender = savedGender;
                // Set the calculator's gender selection to the saved value
                const genderSelect = document.getElementById('gender');
                if (genderSelect) {
                    genderSelect.value = userGender;
                }
            }
            
            // 2. Apply theme based on loaded gender (don't save again on load)
            updateTheme(userGender, false); 
            
            // 3. Ensure cycle fields are correctly toggled based on the saved gender
            toggleCycleTrackingFields(); 

            // 4. Apply initial translations
            applyTranslations();
        }


        /**
         * Applies the translations based on the currentLang setting.
         */
        function applyTranslations() {
            // Update the HTML direction attribute
            const html = document.documentElement;
            const newDir = currentLang === 'ar' ? 'rtl' : 'ltr';
            html.setAttribute('lang', currentLang);
            html.setAttribute('dir', newDir);
            
            // Update all elements with a translation key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = translations[currentLang][key];
                
                if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                    // Update placeholder
                    element.setAttribute('placeholder', translation || element.getAttribute('placeholder'));
                } else if (element.tagName === 'OPTION') {
                    // Update select options
                    element.textContent = translation || element.textContent;
                } else if (element.tagName === 'TITLE') {
                    document.title = translation || element.textContent;
                } else if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update the language toggle button text
            document.getElementById('current-lang').textContent = translations[currentLang].lang_code;
            
            // Re-create Lucide icons after translation
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        /**
         * Toggles the language between 'en' and 'ar'.
         */
        function toggleLanguage() {
            currentLang = (currentLang === 'en') ? 'ar' : 'en';
            localStorage.setItem('malfitLang', currentLang);
            applyTranslations();
        }


        /**
         * Shows or hides the cycle tracking fields and navigation link based on the user's gender.
         */
        function toggleCycleTrackingFields() {
            const isFemale = userGender === 'female';
            const cycleFields = document.getElementById('cycle-tracking-fields');
            
            const navPeriodDesktop = document.getElementById('nav-period-desktop');
            const navPeriodMobile = document.getElementById('nav-period-mobile');

            if (isFemale) {
                cycleFields.classList.remove('hidden');
                navPeriodDesktop.classList.remove('hidden-until-female');
                navPeriodMobile.classList.remove('hidden-until-female');
            } else {
                cycleFields.classList.add('hidden');
                navPeriodDesktop.classList.add('hidden-until-female');
                navPeriodMobile.classList.add('hidden-until-female');
            }
        }


        // --- CORE CALCULATION LOGIC ---

        function calculatePlan() {
            try {
                displayWarning(null); // Clear previous warnings
                document.getElementById('result-box').classList.add('hidden');

                const age = parseFloat(document.getElementById('age').value);
                const gender = document.getElementById('gender').value;
                const height = parseFloat(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const activityFactor = parseFloat(document.getElementById('activity').value);
                const goalWeight = parseFloat(document.getElementById('goal_weight').value);
                const timeFrameWeeks = parseFloat(document.getElementById('time_frame').value);

                // Validation
                if (!age || !height || !weight || !goalWeight || !timeFrameWeeks || age <= 0 || height <= 0 || weight <= 0 || goalWeight <= 0 || timeFrameWeeks <= 0) {
                    displayWarning('warning_fill_fields');
                    return;
                }

                const minSafeCalories = (gender === 'male') ? MIN_CALORIES_MALE : MIN_CALORIES_FEMALE;
                
                // 1. Calculate BMR and TDEE
                const bmr = calculateBMR(weight, height, age, gender);
                const tdee = calculateTDEE(bmr, activityFactor);
                
                // 2. Calculate Required Daily Deficit
                const totalCalorieDeficit = goalWeight * KCAL_PER_KG_FAT;
                const totalDays = timeFrameWeeks * DAYS_IN_WEEK;
                const requiredDailyDeficit = totalCalorieDeficit / totalDays;
                
                // 3. Calculate Target Calories
                let targetCalories = Math.round(tdee - requiredDailyDeficit);
                let dailyLossKg = goalWeight / totalDays;

                // 4. Safety Check
                if (targetCalories < minSafeCalories) {
                    // Recalculate based on minimum safe calories
                    targetCalories = minSafeCalories;
                    
                    const actualDailyDeficit = tdee - minSafeCalories;
                    const resultingDays = totalCalorieDeficit / actualDailyDeficit;
                    const resultingWeeks = Math.ceil(resultingDays / DAYS_IN_WEEK);

                    displayWarning('warning_goal_too_fast', {
                        safeMinimum: minSafeCalories,
                        resultingWeeks: resultingWeeks
                    });
                } else if (dailyLossKg * DAYS_IN_WEEK > 1.5) { // Warning for very rapid weight loss (> 1.5kg/week)
                    displayWarning('warning_loss_fast');
                }

                // 5. Update Results UI
                document.getElementById('tdee-output').textContent = Math.round(tdee).toLocaleString();
                document.getElementById('target-calories-output').textContent = targetCalories.toLocaleString();
                document.getElementById('weekly-loss-output').textContent = (dailyLossKg * DAYS_IN_WEEK).toFixed(2);
                document.getElementById('result-box').classList.remove('hidden');

                // 6. Store Last Result for saving
                lastTdee = Math.round(tdee);
                lastTargetCalories = targetCalories;
                lastGoalWeight = goalWeight;
                lastTimeFrameWeeks = timeFrameWeeks;

            } catch (error) {
                console.error("Calculation failed:", error);
                const fallbackTarget = (document.getElementById('gender').value === 'male') ? 1800 : 1500;
                document.getElementById('tdee-output').textContent = 'â€”';
                document.getElementById('target-calories-output').textContent = fallbackTarget;
                document.getElementById('result-box').classList.remove('hidden');
                displayWarning('warning_error', { fallbackTarget: fallbackTarget });
            }
        }

        /**
         * Saves the last calculated plan to Local Storage and redirects.
         */
        function saveCaloriePlan() {
            if (lastTargetCalories === 0) {
                alert(translations[currentLang].warning_no_plan_to_save);
                return;
            }

            const planData = {
                type: lastGoalType,
                target: lastTargetCalories,
                maintenance: lastTdee,
                goal_kg: lastGoalWeight,
                time_weeks: lastTimeFrameWeeks,
                date: new Date().toISOString().slice(0, 10) 
            };

            // Retrieve existing plans or start a new array
            let existingPlans = JSON.parse(localStorage.getItem('malfitPlans')) || [];
            existingPlans.unshift(planData); // Add new plan to the start

            // Save back to local storage
            localStorage.setItem('malfitPlans', JSON.stringify(existingPlans));

            alert(translations[currentLang].alert_plan_saved);
            // In a real application, you'd redirect here:
            // window.location.href = '../Plans/plans.html';
        }


        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. MALFIT Mobile Menu Toggle Handler ---
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const langToggle = document.getElementById('lang-toggle'); 

            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('active');
            });
            
            // Close menu when a link is clicked
            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.remove('active');
                });
            });
            
            // --- 2. Language Toggle Handler ---
            langToggle.addEventListener('click', toggleLanguage);
            
            // --- 3. Initial Load (Translations & Theme) ---
            loadUserPreferences();
            
            // --- 4. Falling Food Background Animation Script ---
            const produceEmojis = ['ðŸŽ', 'ðŸŠ', 'ðŸ‹', 'ðŸ‡', 'ðŸ“', 'ðŸ', 'ðŸ¥¦', 'ðŸ¥•', 'ðŸ¥¬', 'ðŸŒ¶ï¸', 'ðŸŒ½', 'ðŸ¥'];
            const body = document.body;
            const maxItems = 40; 
            let itemsOnScreen = 0;

            function createFallingItem() {
                if (itemsOnScreen >= maxItems) return;

                const emoji = produceEmojis[Math.floor(Math.random() * produceEmojis.length)];
                const size = Math.floor(Math.random() * 15) + 12; 
                const initialX = Math.random() * window.innerWidth;
                const duration = Math.random() * 8 + 4; 
                const rotation = Math.random() * 360; 
                
                const item = document.createElement('div');
                item.className = 'falling-item';
                item.innerHTML = emoji;
                item.style.fontSize = `${size}px`;
                item.style.left = `${initialX}px`;
                item.style.top = `-50px`; 
                item.style.transform = `rotate(${rotation}deg)`;
                
                body.appendChild(item);
                itemsOnScreen++;

                let currentY = -50;
                const speed = (window.innerHeight + 100) / (duration * 60); 
                const driftX = (Math.random() - 0.5) * 0.5; 

                function animateFall() {
                    if (currentY > window.innerHeight) {
                        if (body.contains(item)) {
                            body.removeChild(item);
                        }
                        itemsOnScreen--;
                        return;
                    }

                    currentY += speed;
                    let currentX = parseFloat(item.style.left) || initialX;
                    currentX += driftX;

                    item.style.top = `${currentY}px`;
                    item.style.left = `${currentX}px`;
                    
                    requestAnimationFrame(animateFall);
                }

                requestAnimationFrame(animateFall);
            }

            function spawnLoop() {
                createFallingItem();
                // Spawn a new item every 100ms to 500ms
                const delay = Math.random() * 400 + 100;
                setTimeout(spawnLoop, delay);
            }

            spawnLoop();
        });
    </script>
</body>
</html>
