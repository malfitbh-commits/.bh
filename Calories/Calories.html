<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="page_title">MALFIT | Calorie</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 

    <style>
        /* Custom styles from the previous file */
        :root {
            --primary-color: #4f46e5; /* Default: indigo-600 */
            --primary-light: #eef2ff; /* Default: indigo-50 */
            --logo-color: #4f46e5;
            --calc-gradient-start: #4f46e5; /* Indigo */
            --calc-gradient-end: #3b82f6; /* Blue */
        }
        
        /* --- START: FEMALE THEME OVERRIDE --- */
        .female-theme {
            --primary-color: #ec4899; /* Pink-600 */
            --primary-light: #fdf2f8; /* Pink-50 */
            --logo-color: #ec4899;
            --calc-gradient-start: #ec4899; /* Pink */
            --calc-gradient-end: #f43f5e; /* Rose */
        }
        
        /* Hide Period link until Female theme is active */
        .hidden-until-female {
            display: none !important;
        }
        /* --- END: FEMALE THEME OVERRIDE --- */


        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* Softer, slightly blue background */
            overflow-x: hidden; 
            min-height: 100vh;
            position: relative; 
        }

        /* Apply Arabic font when direction is RTL */
        html[dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }

        /* --- Custom Nav Link Styles (Pill-shaped) --- */
        .nav-link {
            text-decoration: none;
            color: #474646;
            font-weight: 500;
            padding: 10px 15px; 
            margin-right: 10px;
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
            border-radius: 9999px; /* Pill shape */
            white-space: nowrap;
        }
        /* Highlight the active link for this page */
        .nav-link.active-calorie {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            font-weight: 700;
        }
        .nav-link:hover {
            color: var(--primary-color); 
            background-color: var(--primary-light); 
            transform: translateY(-1px);
        }
        
        /* Adjustments for RTL layout for links */
        html[dir="rtl"] header nav .nav-link {
            margin-right: 0;
            margin-left: 10px;
        }
        
        /* --- Header Specific Styles --- */
        header {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Stronger header shadow */
            background-color: #ffffff;
            transition: box-shadow 0.3s ease-in-out;
        }
        
        /* --- Mobile Menu Styles (Using existing Tailwind classes for responsiveness) --- */
        #mobile-menu {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            background-color: #ffffff;
            position: absolute;
            top: 70px; 
            right: 0;
            left: 0;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        #mobile-menu.active {
            max-height: 500px;
            opacity: 1;
            padding: 10px 0;
        }
        #mobile-menu a {
            display: block;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            color: #333;
            text-decoration: none;
            text-align: left; 
            transition: background-color 0.15s;
        }
        #mobile-menu a:hover {
            background-color: var(--primary-light);
        }
        html[dir="rtl"] #mobile-menu a {
            text-align: right; 
        }

        /* Icon Button Styling */
        .icon-btn {
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            display: flex; 
            align-items: center;
            justify-content: center;
            color: #4b5563; /* gray-700 */
        }
        .icon-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        /* Specific RTL fix for button icon placement (mr-2 equivalent for RTL) */
        .rtl-ml-2 {
            margin-right: 0.5rem; 
        }
        html[dir="rtl"] .rtl-ml-2 {
            margin-right: 0;
            margin-left: 0.5rem; 
        }
        
        /* Enhanced Contact Button Gradient - Uses CSS variables */
        .contact-btn {
            background-image: linear-gradient(to right, var(--calc-gradient-start) 0%, var(--calc-gradient-end) 100%); 
            transition: all 0.2s ease;
        }
        .contact-btn:hover {
            box-shadow: 0 8px 15px rgba(63, 131, 248, 0.4); /* General shadow for hover effect */
            transform: scale(1.02);
            opacity: 0.95;
        }
        
        /* Centering for the main card container */
        .min-h-main {
            min-height: calc(100vh - 140px);
        }
        @media (min-width: 768px) {
            .min-h-main {
                min-height: calc(100vh - 120px); 
            }
        }

        /* Calculator Specific Styles */
        .input-style {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
            color: #1f2937;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--primary-color); /* Uses CSS Variable */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .result-box-style {
            background-color: var(--primary-light); /* Uses CSS Variable */
            border-left: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
        html[dir="rtl"] .result-box-style {
            border-left: none;
            border-right: 4px solid var(--primary-color); /* Uses CSS Variable */
        }
    </style>
</head>
<body>
    
    <header class="sticky top-0 z-50 w-full flex items-center justify-between px-4 md:px-8 lg:px-16 py-3 bg-white border-b border-gray-100">
        
        <div class="flex items-center">
            <a href="afterthelogpage.html" id="logo" class="text-3xl font-extrabold text-indigo-600 tracking-wide" data-translate-key="logo" aria-label="Go to Homepage">MALFIT</a>
        </div>

        <nav class="hidden md:flex flex-grow justify-center mx-10">
           <a href="Calories/Calories.html" data-translate-key="nav_calories">Calories</a>
            <a href="Period/Period.html" id="nav-period-mobile" class="hidden-until-female" data-translate-key="nav_period">Period</a>
            <a href="Eat Healthy/Eathealrhy.html" data-translate-key="nav_eat_healthy">Eat Healthy</a>
            <a href="Plans/Plans.html" data-translate-key="nav_plans">Plans</a>
            <a href="Clubs/Club.html" data-translate-key="nav_clubs">Clubs</a>
            <a href="Survey/Survey.html" data-translate-key="nav_survey">Survey</a>
            <a href="Contact Us/Contact us.html" data-translate-key="nav_contact_us">Contact Us</a>
        </nav>

        <div class="icons-container flex items-center gap-2 md:gap-4">
            
            <button id="lang-toggle" class="icon-btn w-10 h-10 border-2 border-gray-300 hover:border-indigo-600" aria-label="Toggle language">
                <span id="current-lang" class="text-sm font-bold">EN</span> 
            </button>

            <a href="Home/Home.html" class="icon-btn hover:bg-indigo-50" aria-label="Home">
                <svg data-lucide="home" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <a href="accountData.html" class="icon-btn hover:bg-indigo-50" aria-label="Account Settings">
                <svg data-lucide="user" width="24" height="24" aria-hidden="true"></svg>
            </a>

            <button id="menu-toggle" class="md:hidden icon-btn" aria-label="Toggle mobile menu">
                <svg data-lucide="menu" width="24" height="24" aria-hidden="true"></svg>
            </button>
        </div>
    </header>

    <div id="mobile-menu" class="md:hidden">
        <a href="Calories/Calories.html" data-translate-key="nav_calories">Calories</a>
        <a href="Period/Period.html" id="nav-period-mobile" class="hidden-until-female" data-translate-key="nav_period">Period</a>
        <a href="Eat Healthy/Eathealrhy.html" data-translate-key="nav_eat_healthy">Eat Healthy</a>
        <a href="Plans/Plans.html" data-translate-key="nav_plans">Plans</a>
        <a href="Clubs/Club.html" data-translate-key="nav_clubs">Clubs</a>
        <a href="Survey/Survey.html" data-translate-key="nav_survey">Survey</a>
        <a href="Contact Us/Contact us.html" data-translate-key="nav_contact_us">Contact Us</a>
    </div>

    <main class="flex items-center justify-center p-4 min-h-main"> 
    
        <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 sm:p-8 border border-blue-50/50 transform transition-all duration-300 hover:shadow-indigo-200/50">

            <div class="text-center">
                <div id="calculator-icon-container" class="mx-auto w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center shadow-lg">
                    <svg data-lucide="calculator" width="28" height="28" stroke="white" stroke-width="2.5" aria-hidden="true"></svg>
                </div>
                <h1 class="mt-6 text-3xl font-extrabold text-gray-900 leading-tight" data-translate-key="calc_title">Calculate Calories</h1>
                <p class="mt-3 text-md text-gray-500 max-w-md mx-auto" data-translate-key="calc_subtitle">Find your daily calorie target based on your goal.</p>
            </div>

            <div class="space-y-4 mt-8">
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_age">Your Age (Years)</label>
                        <input type="number" id="age" min="15" class="input-style" placeholder="e.g., 30">
                    </div>
                    <div class="w-1/2">
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_gender">Are you Male or Female?</label>
                        <select id="gender" class="input-style" onchange="updateTheme(this.value); toggleCycleTrackingFields();">
                            <option value="male" data-translate-key="option_male">Male</option>
                            <option value="female" data-translate-key="option_female">Female</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="height" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_height">Your Height (cm)</label>
                        <input type="number" id="height" min="100" class="input-style" placeholder="e.g., 175">
                    </div>
                    <div class="w-1/2">
                        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_weight">Your Current Weight (kg)</label>
                        <input type="number" id="weight" min="40" class="input-style" placeholder="e.g., 75">
                    </div>
                </div>

                <div id="cycle-tracking-fields" class="hidden">
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="cycle_length" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_cycle_length">Average Cycle Length (Days)</label>
                            <input type="number" id="cycle_length" min="20" max="45" class="input-style" placeholder="e.g., 28">
                        </div>
                        <div class="w-1/2">
                            <label for="last_period_start" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_last_period">Last Period Start Date</label>
                            <input type="date" id="last_period_start" class="input-style">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="activity" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_activity">How Active Are You?</label>
                    <select id="activity" class="input-style">
                        <option value="1.2" data-translate-key="activity_1_2">Not Active (Desk job, little exercise)</option>
                        <option value="1.375" data-translate-key="activity_1_375">A Bit Active (Exercise 1-3 times a week)</option>
                        <option value="1.55" selected data-translate-key="activity_1_55">Active (Exercise 3-5 times a week)</option>
                        <option value="1.725" data-translate-key="activity_1_725">Very Active (Exercise 6-7 times a week)</option>
                        <option value="1.9" data-translate-key="activity_1_9">Extremely Active (Hard exercise + physical job)</option>
                    </select>
                </div>

                <hr class="border-gray-200 pt-2">

                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="goal_weight" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_goal_weight">How many kg do you want to lose?</label>
                        <input type="number" id="goal_weight" min="0.5" class="input-style" placeholder="e.g., 5">
                    </div>
                    <div class="w-1/2">
                        <label for="time_frame" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_time_frame">How many Weeks do you have?</label>
                        <input type="number" id="time_frame" min="1" class="input-style" placeholder="e.g., 8">
                    </div>
                </div>

                <button onclick="calculatePlan()" 
                    class="contact-btn w-full flex items-center justify-center px-8 py-4 text-lg font-semibold rounded-2xl shadow-xl text-white mt-6">
                    <span data-translate-key="btn_calculate">Find My Daily Calorie Goal</span>
                </button>
            </div>

            <div id="result-box" class="mt-8 p-6 result-box-style rounded-lg hidden">
                <h2 class="text-xl font-bold text-indigo-800 mb-3" data-translate-key="result_title">Your Simple Plan</h2>
                
                <p class="text-gray-700 mb-3">
                    <span class="font-semibold" data-translate-key="result_maintenance">Calories to Stay the Same:</span> 
                    <span id="tdee-output"></span> kcal
                </p>

                <div class="bg-indigo-200 p-4 rounded-md">
                    <p class="text-lg font-bold text-indigo-900" data-translate-key="result_daily_goal">Your Target Daily Calorie Goal is:</p>
                    <p class="text-4xl font-extrabold text-indigo-700 mt-1"><span id="target-calories-output"></span> kcal</p>
                </div>
                
                <button onclick="saveCaloriePlan()" class="contact-btn w-full flex items-center justify-center px-4 py-3 text-base font-semibold rounded-xl shadow-lg text-white mt-4 transition-all duration-200">
                    <svg data-lucide="plus-circle" width="20" height="20" class="rtl-ml-2" aria-hidden="true"></svg>
                    <span data-translate-key="btn_add_to_plane">Add to Plan</span>
                </button>
                
                <p class="text-sm text-gray-600 mt-4">
                    <span data-translate-key="result_weekly_loss_info_part1">To reach your goal on time, you need to lose about </span>
                    <span id="weekly-loss-output" class="font-bold"></span> 
                    <span data-translate-key="result_weekly_loss_info_part2"> kg each week.</span>
                </p>
            </div>

            <div id="warning-box" class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg hidden">
                <p id="warning-message" class="text-sm font-medium text-yellow-800"></p>
            </div>

        </div>
    </main>

    <footer class="p-6 bg-white border-t border-gray-100 shadow-inner">
        <p class="text-gray-600 text-center text-sm" data-translate-key="footer_text">&copy; 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi</p>
    </footer>

    <script>
        // --- GLOBAL STATE ---
        // Initialize currentLang from localStorage or default to 'en'
        let currentLang = localStorage.getItem('malfitLang') || 'en';

        // Constants for Calculation Logic
        const KCAL_PER_KG_FAT = 7700;
        const MIN_CALORIES_MALE = 1500;
        const MIN_CALORIES_FEMALE = 1200; // Standard minimum for healthy female weight loss

        // --- GLOBAL VARIABLES TO STORE LAST RESULT ---
        let lastTdee = 0;
        let lastTargetCalories = 0;
        let lastGoalWeight = 0;
        let lastTimeFrameWeeks = 0;
        let lastGoalType = 'lose'; // Default type for the Calorie Plan
        // --------------------------------------------------

        // --- TRANSLATION DATA (FIXED AND COMPLETE) ---
        const translations = {
            'en': {
                'page_title': 'MALFIT | Calorie',
                'logo': 'MALFIT',
                'nav_calories': 'Calories',
                'nav_period': 'Period',
                'nav_eat_healthy': 'Eat Healthy',
                'nav_plans': 'Plans',
                'nav_clubs': 'Clubs',
                'nav_survey': 'Survey',
                'nav_contact_us': 'Contact Us',
                'footer_text': '© 2025, Senior Project, Mada Saleh, Ahmed Khalifa, Lora Adel, Supervisor Dr.Abdulla Mohamed Khalid Alqaddoumi',
                'lang_code': 'AR', 

                // NEW Cycle Tracking Translations
                'label_cycle_length': 'Average Cycle Length (Days)',
                'label_last_period': 'Last Period Start Date',

                // Calculator Specific Translations
                'calc_title': 'Calculate Calories',
                'calc_subtitle': 'Find your daily calorie target based on your goal.',
                'label_age': 'Your Age (Years)',
                'label_gender': 'Are you Male or Female?',
                'option_male': 'Male',
                'option_female': 'Female',
                'label_height': 'Your Height (cm)',
                'label_weight': 'Your Current Weight (kg)',
                'label_activity': 'How Active Are You?',
                'activity_1_2': 'Not Active (Desk job, little exercise)',
                'activity_1_375': 'A Bit Active (Exercise 1-3 times a week)',
                'activity_1_55': 'Active (Exercise 3-5 times a week)',
                'activity_1_725': 'Very Active (Exercise 6-7 times a week)',
                'activity_1_9': 'Extremely Active (Hard exercise + physical job)',
                'label_goal_weight': 'How many kg do you want to lose?',
                'label_time_frame': 'How many Weeks do you have?',
                'btn_calculate': 'Find My Daily Calorie Goal',
                
                // Result Box Translations
                'result_title': 'Your Simple Plan',
                'result_maintenance': 'Calories to Stay the Same:',
                'result_daily_goal': 'Your Target Daily Calorie Goal is:',
                'btn_add_to_plane': 'Add to Plan',
                'result_weekly_loss_info_part1': 'To reach your goal on time, you need to lose about ',
                'result_weekly_loss_info_part2': ' kg each week.',
                
                // Warning Messages
                'warning_fill_fields': 'Please fill in all required fields to calculate your plan.',
                'warning_no_plan_to_save': 'Please calculate a plan first.',
                'warning_goal_too_fast': 'Warning: Goal too aggressive! To maintain health, we recommend a minimum of {safeMinimum} kcal/day. This will take about {resultingWeeks} weeks.',
                'warning_loss_fast': 'Warning: Losing weight this quickly can be challenging. We recommend consulting a professional.',
                'warning_error': 'Calculation Error: Using fallback target of {fallbackTarget} kcal.',
                'alert_plan_saved': 'Plan saved successfully! Redirecting to Plans page.',
            },
            'ar': {
                'page_title': 'ملفت | السعرات الحرارية',
                'logo': 'ملفت',
                'nav_calories': 'السعرات الحرارية',
                'nav_period': 'الدورة الشهرية',
                'nav_eat_healthy': 'تناول طعام صحي',
                'nav_plans': 'الخطط',
                'nav_clubs': 'الأندية',
                'nav_survey': 'الاستبيان',
                'nav_contact_us': 'اتصل بنا',
                'footer_text': '© 2025، مشروع تخرج، مدى صالح، أحمد خليفة، لورا عادل، المشرف الدكتور عبد الله محمد خالد القادومي',
                'lang_code': 'EN', 
                
                // NEW Cycle Tracking Translations
                'label_cycle_length': 'متوسط طول الدورة (بالأيام)',
                'label_last_period': 'تاريخ بدء آخر دورة',

                // Calculator Specific Translations
                'calc_title': 'حساب السعرات الحرارية',
                'calc_subtitle': 'اعثر على هدفك اليومي من السعرات الحرارية بناءً على هدفك.',
                'label_age': 'عمرك (بالسنوات)',
                'label_gender': 'هل أنت ذكر أم أنثى؟',
                'option_male': 'ذكر',
                'option_female': 'أنثى',
                'label_height': 'طولك (بالسنتيمتر)',
                'label_weight': 'وزنك الحالي (بالكيلوجرام)',
                'label_activity': 'ما مدى نشاطك؟',
                'activity_1_2': 'غير نشط (عمل مكتبي، قليل من الرياضة)',
                'activity_1_375': 'نشط قليلاً (رياضة 1-3 مرات في الأسبوع)',
                'activity_1_55': 'نشط (رياضة 3-5 مرات في الأسبوع)',
                'activity_1_725': 'نشط جداً (رياضة 6-7 مرات في الأسبوع)',
                'activity_1_9': 'نشط للغاية (رياضة شاقة + وظيفة تتطلب جهداً بدنياً)',
                'label_goal_weight': 'كم كيلوغراماً تريد أن تخسر؟',
                'label_time_frame': 'كم أسبوعاً لديك؟',
                'btn_calculate': 'اكتشف هدفي اليومي من السعرات', 
                
                // Result Box Translations
                'result_title': 'خطتك البسيطة',
                'result_maintenance': 'السعرات الحرارية للحفاظ على الوزن:',
                'result_daily_goal': 'هدف السعرات اليومي المستهدف هو:',
                'btn_add_to_plane': 'أضف إلى الخطة',
                'result_weekly_loss_info_part1': 'للوصول إلى هدفك في الوقت المحدد، تحتاج إلى خسارة حوالي ',
                'result_weekly_loss_info_part2': ' كجم كل أسبوع.',
                
                // Warning Messages
                'warning_fill_fields': 'الرجاء ملء جميع الحقول المطلوبة لحساب خطتك.',
                'warning_no_plan_to_save': 'الرجاء حساب الخطة أولاً.',
                'warning_goal_too_fast': 'تحذير: الهدف مفرط في السرعة! للحفاظ على الصحة، نوصي بحد أدنى {safeMinimum} سعرة حرارية/يوم. سيستغرق هذا حوالي {resultingWeeks} أسابيع.',
                'warning_loss_fast': 'تحذير: خسارة الوزن بهذه السرعة قد تكون صعبة. نوصي باستشارة مختص.',
                'warning_error': 'خطأ في الحساب: سيتم استخدام الهدف الافتراضي {fallbackTarget} سعرة حرارية.',
                'alert_plan_saved': 'تم حفظ الخطة بنجاح! سيتم إعادة توجيهك إلى صفحة الخطط.',
            }
        };


        /**
         * Applies the translations based on the currentLang setting.
         */
        function applyTranslations() {
            // Update the HTML direction attribute
            const html = document.documentElement;
            const newDir = currentLang === 'ar' ? 'rtl' : 'ltr';
            html.setAttribute('lang', currentLang);
            html.setAttribute('dir', newDir);
            
            // Update all elements with a translation key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = translations[currentLang][key];
                
                if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                    element.setAttribute('placeholder', translation || element.getAttribute('placeholder'));
                } else if (element.tagName === 'TITLE') {
                    document.title = translation || element.textContent;
                } else if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update the language toggle button text
            document.getElementById('current-lang').textContent = translations[currentLang].lang_code;

            // Re-apply theme to ensure class dependencies are updated (e.g., in result-box)
            const genderSelect = document.getElementById('gender');
            if (genderSelect) {
                updateTheme(genderSelect.value);
            }
            
            // Re-create Lucide icons after translation
            lucide.createIcons();
        }

        /**
         * Toggles the language and re-applies translations.
         */
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('malfitLang', currentLang); // Save preference
            applyTranslations();
        }

        /**
         * Toggles the visibility of cycle tracking fields based on gender selection.
         */
        function toggleCycleTrackingFields() {
            const gender = document.getElementById('gender').value;
            const cycleFields = document.getElementById('cycle-tracking-fields');
            
            if (gender === 'female') {
                cycleFields.classList.remove('hidden');
            } else {
                cycleFields.classList.add('hidden');
            }
        }

        /**
         * Changes the theme colors (CSS variables and Tailwind classes) to pink if female.
         * Hides/shows the "Period" header link.
         * @param {string} gender - The selected gender ('male' or 'female').
         */
        function updateTheme(gender) {
            const html = document.documentElement;
            const logo = document.getElementById('logo');
            const resultBox = document.getElementById('result-box');
            
            // This line handles the result box inner color change for dynamic content
            let resultBoxInner = resultBox ? resultBox.querySelector('div.p-4') : null;
            
            const iconContainer = document.getElementById('calculator-icon-container');
            const periodDesktop = document.getElementById('nav-period-desktop');
            const periodMobile = document.getElementById('nav-period-mobile');

            if (gender === 'female') {
                html.classList.add('female-theme');
                if (logo) logo.classList.replace('text-indigo-600', 'text-pink-600');
                
                // Icon gradient classes for Pink
                iconContainer.classList.remove('from-indigo-500', 'to-blue-500');
                iconContainer.classList.add('from-pink-500', 'to-rose-500');
                
                // Update result box background class for Pink
                if (resultBoxInner) {
                    resultBoxInner.classList.replace('bg-indigo-200', 'bg-pink-200');
                }
                resultBox.classList.replace('text-indigo-800', 'text-pink-800');
                resultBox.querySelector('#target-calories-output').parentNode.classList.replace('text-indigo-700', 'text-pink-700');


                // Show Period links
                if (periodDesktop) periodDesktop.classList.remove('hidden-until-female');
                if (periodMobile) periodMobile.classList.remove('hidden-until-female');
            } else {
                html.classList.remove('female-theme');
                if (logo) logo.classList.replace('text-pink-600', 'text-indigo-600');
                
                // Icon gradient classes back to Indigo/Blue
                iconContainer.classList.remove('from-pink-500', 'to-rose-500');
                iconContainer.classList.add('from-indigo-500', 'to-blue-500');
                
                // Update result box background class back to indigo
                if (resultBoxInner) {
                    resultBoxInner.classList.replace('bg-pink-200', 'bg-indigo-200'); 
                }
                resultBox.classList.replace('text-pink-800', 'text-indigo-800');
                resultBox.querySelector('#target-calories-output').parentNode.classList.replace('text-pink-700', 'text-indigo-700');


                // Hide Period links
                if (periodDesktop) periodDesktop.classList.add('hidden-until-female');
                if (periodMobile) periodMobile.classList.add('hidden-until-female');
            }
        }

        /**
         * Core Calculation Function
         * Uses the Mifflin-St Jeor Equation for BMR and TDEE.
         */
        function calculatePlan() {
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityMultiplier = parseFloat(document.getElementById('activity').value);
            const goalWeight = parseFloat(document.getElementById('goal_weight').value);
            const timeFrameWeeks = parseFloat(document.getElementById('time_frame').value);

            const resultBox = document.getElementById('result-box');
            const warningBox = document.getElementById('warning-box');
            warningBox.classList.add('hidden');
            resultBox.classList.add('hidden');
            
            // Determine Goal Type (Loss/Maintenance/Gain)
            let goalType;
            if (goalWeight > 0) {
                // If goal weight is positive (e.g., 5kg loss), the intent is 'lose'
                goalType = 'lose'; 
            } else if (goalWeight === 0) {
                // If user wants to lose 0kg, the goal is 'maintain' (requires specific handling or user intent adjustment)
                // For simplicity here, we assume if goalWeight is 0, the user wants maintenance.
                goalType = 'maintain';
            } else {
                // Not covered in this calculator, but conceptually could be 'gain'
                goalType = 'lose'; // Fallback to 'lose' for safety
            }

            // 1. Input Validation (Checks for NaN, minimums, and positive goals/time)
            if (isNaN(age) || isNaN(height) || isNaN(weight) || isNaN(goalWeight) || isNaN(timeFrameWeeks) || 
                age < 15 || height < 100 || weight < 40 || timeFrameWeeks <= 0 || goalWeight < 0) { // Goal weight cannot be negative for loss calc
                
                warningBox.classList.remove('hidden');
                document.getElementById('warning-message').textContent = translations[currentLang].warning_fill_fields;
                return;
            }
            
            // If the goal is 0, calculate maintenance only
            if (goalWeight === 0) {
                goalType = 'maintain';
            }

            // 2. Calculate BMR (Mifflin-St Jeor Equation)
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            // 3. Calculate TDEE (Maintenance Calories)
            const tdee = bmr * activityMultiplier;
            const roundedTdee = Math.round(tdee);

            let targetCalories;
            let finalDailyDeficit;
            let finalWeeklyLoss;
            let safeMinimum = (gender === 'male') ? MIN_CALORIES_MALE : MIN_CALORIES_FEMALE; 
            let warningMessageKey = '';
            let resultingWeeks = timeFrameWeeks;


            if (goalType === 'maintain') {
                // Target calories is just maintenance
                targetCalories = roundedTdee;
                finalDailyDeficit = 0;
                finalWeeklyLoss = 0;
            } else { // goalType is 'lose'
                // 4. Calculate Required Deficit for Loss
                const totalTimeDays = timeFrameWeeks * 7;
                const totalDeficitKcal = goalWeight * KCAL_PER_KG_FAT;
                const dailyDeficit = totalDeficitKcal / totalTimeDays;
                
                // 5. Calculate Target Calories
                targetCalories = tdee - dailyDeficit;
                
                // 6. Safety & Reality Checks
                if (targetCalories < safeMinimum) {
                    // Adjust to the safe minimum
                    targetCalories = safeMinimum;
                    const resultingDailyDeficit = tdee - safeMinimum;
                    // Calculate the new, safer time frame required for the original goal
                    resultingWeeks = totalDeficitKcal / resultingDailyDeficit / 7;
                    
                    warningMessageKey = 'warning_goal_too_fast';
                } else if ((dailyDeficit * 7 / KCAL_PER_KG_FAT) > 1.2) { 
                    warningMessageKey = 'warning_loss_fast';
                } else if (targetCalories <= 0) {
                    // Final safety net check
                    targetCalories = roundedTdee - 500; 
                    warningMessageKey = 'warning_error';
                }

                // Update output based on the (potentially adjusted) target calories
                finalDailyDeficit = Math.round(roundedTdee - targetCalories);
                finalWeeklyLoss = (finalDailyDeficit * 7 / KCAL_PER_KG_FAT).toFixed(2);
            }
            
            // Finalize target calories
            const finalTargetCalories = Math.round(targetCalories);

            // 7. Store results globally for the savePlan function
            lastTdee = roundedTdee;
            lastTargetCalories = finalTargetCalories;
            lastGoalWeight = goalWeight;
            lastTimeFrameWeeks = timeFrameWeeks;
            lastGoalType = goalType;

            // 8. Display Results
            document.getElementById('tdee-output').textContent = roundedTdee.toLocaleString();
            document.getElementById('target-calories-output').textContent = finalTargetCalories.toLocaleString();
            document.getElementById('weekly-loss-output').textContent = finalWeeklyLoss > 0 ? finalWeeklyLoss : '0.00'; 
            
            resultBox.classList.remove('hidden');
            
            // 9. Display Warning if applicable
            if (warningMessageKey) {
                warningBox.classList.remove('hidden');
                let message = translations[currentLang][warningMessageKey];
                
                if (warningMessageKey === 'warning_goal_too_fast') {
                    message = message.replace('{safeMinimum}', safeMinimum.toLocaleString()).replace('{resultingWeeks}', resultingWeeks.toFixed(1));
                } else if (warningMessageKey === 'warning_error') {
                    message = message.replace('{fallbackTarget}', Math.round(roundedTdee - 500).toLocaleString());
                }
                
                document.getElementById('warning-message').textContent = message;
            }
            
            // Re-create Lucide icons after injecting HTML
            lucide.createIcons();
        }

        /**
         * Saves the last calculated plan to Local Storage
         * and redirects the user to the Plans page.
         */
        function saveCaloriePlan() {
            if (lastTargetCalories === 0) {
                alert(translations[currentLang].warning_no_plan_to_save || "Please calculate a plan first.");
                return;
            }

            let goalTypeText;
            if (lastGoalType === 'maintain') {
                goalTypeText = 'maintain';
            } else if (lastGoalType === 'lose') {
                goalTypeText = 'lose';
            } else {
                 goalTypeText = 'gain';
            }
            
            const planData = {
                tdee: lastTdee,
                target: lastTargetCalories, // Using 'target' to match the plans.html card structure
                type: goalTypeText,
                dateSaved: new Date().toISOString()
            };

            // Save the calorie plan data to Local Storage under a specific key
            localStorage.setItem('savedCalorieGoal', JSON.stringify(planData));

            alert(translations[currentLang].alert_plan_saved || "Plan saved successfully! Redirecting to Plans page.");
            window.location.href = 'Plans/Plans.html'; // Ensure this points to your plans page
        }

        /**
         * Toggles the mobile menu open/closed.
         */
        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('active');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Apply initial language and theme
            applyTranslations(); 
            toggleCycleTrackingFields(); // Initial toggle based on default/saved gender

            // 2. Event Listeners
            document.getElementById('menu-toggle').addEventListener('click', toggleMobileMenu);
            document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);
            
            // Add listeners to close menu when link is clicked
            document.getElementById('mobile-menu').querySelectorAll('a').forEach(link => {
                link.addEventListener('click', toggleMobileMenu);
            });
        });
    </script>
</body>
</html>
