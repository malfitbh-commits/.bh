<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="page_title_change_password">MALFIT | Change Password</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script> 
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-light: #eef2ff;
            --calc-gradient-start: #4f46e5;
            --calc-gradient-end: #3b82f6;
        }
        .female-theme {
            --primary-color: #ec4899;
            --primary-light: #fdf2f8;
            --calc-gradient-start: #ec4899;
            --calc-gradient-end: #f43f5e;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; 
            min-height: 100vh;
        }
        html[dir="rtl"] body {
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }
        .contact-btn {
            background-image: linear-gradient(to right, var(--calc-gradient-start) 0%, var(--calc-gradient-end) 100%); 
            transition: all 0.2s ease;
        }
        .contact-btn:hover {
            box-shadow: 0 8px 15px rgba(63, 131, 248, 0.4); 
            transform: scale(1.02);
            opacity: 0.95;
        }
        .input-style {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .alert-box {
            border-left: 4px solid;
        }
        
        .lang-btn-style {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            color: white;
            background-image: linear-gradient(to right, var(--calc-gradient-start) 0%, var(--calc-gradient-end) 100%); 
            transition: all 0.2s ease;
        }
        .lang-btn-style:hover {
            box-shadow: 0 4px 8px rgba(63, 131, 248, 0.4);
            transform: scale(1.05);
            opacity: 0.9;
        }
    </style>
</head>
<body onload="loadUserPreferences()">
    
    <div class="absolute top-4 right-4 z-10 p-2 sm:p-4">
        <button id="lang-toggle-btn" onclick="toggleLanguage()" 
            class="lang-btn-style">
            Ø¹Ø±Ø¨ÙŠ / English
        </button>
    </div>
    <main class="flex items-center justify-center p-4 min-h-screen"> 
        <div class="w-full max-w-md bg-white shadow-2xl rounded-3xl p-8 border border-gray-100/50">

            <div class="text-center">
                <h1 class="text-3xl font-extrabold text-gray-900 leading-tight" data-translate-key="change_title">Change Your Password</h1>
                <p class="mt-2 text-md text-gray-500" data-translate-key="change_subtitle">Enter your current password and choose a new one.</p>
            </div>

            <div class="space-y-5 mt-8">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_current_password">Current Password</label>
                    <input type="password" id="current-password" class="input-style" required>
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_new_password">New Password</label>
                    <input type="password" id="new-password" class="input-style" required>
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="label_confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm-password" class="input-style" required>
                </div>

                <div id="message-box" class="alert-box p-4 rounded-lg hidden" role="alert">
                    <p id="message-text" class="text-sm font-medium"></p>
                </div>

                <button onclick="changePassword()" 
                    class="contact-btn w-full flex items-center justify-center px-8 py-4 text-lg font-semibold rounded-2xl shadow-xl text-white mt-6">
                    <span data-translate-key="btn_change_password">Change Password</span>
                </button>
            </div>
            
            <a href="account.html" class="block text-center mt-6 text-sm text-gray-500 hover:text-indigo-600 transition-colors" data-translate-key="back_to_account">
                &larr; Back to Account
            </a>

        </div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let currentLang = localStorage.getItem('malfitLang') || 'en';
        let userGender = localStorage.getItem('malfitGender') || 'male'; 

        const firebaseConfig = {
            apiKey: "AIzaSyAJrDZrl1jeKFeEsDTM_lUTxxwW7lib5U0",
            authDomain: "malfit-app.firebaseapp.com",
            projectId: "malfit-app",
            storageBucket: "malfit-app.firebasestorage.app",
            messagingSenderId: "118730063574",
            appId: "1:118730063574:web:1a34284a69ae0e7097d377"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const translations = {
            'en': {
                'page_title_change_password': 'MALFIT | Change Password',
                'change_title': 'Change Your Password',
                'change_subtitle': 'Enter your current password and choose a new one.',
                'label_current_password': 'Current Password',
                'label_new_password': 'New Password',
                'label_confirm_password': 'Confirm New Password',
                'btn_change_password': 'Change Password',
                'back_to_account': 'â† Back to Account',
                'success_password_changed': 'Password changed successfully! Redirecting to account page.',
                'error_fill_all': 'Please fill in all fields.',
                'error_match': 'New password and confirmation do not match.',
                'error_current_password': 'Current password entered is incorrect.', // Used for auth/wrong-password
                'error_no_user': 'User not found or not logged in. Please log in first.',
                'error_weak_password': 'The new password is too weak. Please choose a longer, more complex password.', // ðŸ†• New Key
            },
            'ar': {
                'page_title_change_password': 'Ù…Ù„ÙØª | ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                'change_title': 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ',
                'change_subtitle': 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.',
                'label_current_password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
                'label_new_password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                'label_confirm_password': 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                'btn_change_password': 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                'back_to_account': 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ â†',
                'success_password_changed': 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨.',
                'error_fill_all': 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.',
                'error_match': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†.',
                'error_current_password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.',
                'error_no_user': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.',
                'error_weak_password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ø·ÙˆÙ„ ÙˆØ£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ù‹Ø§.', // ðŸ†• New Key
            }
        };


        function updateTheme(gender) {
            document.documentElement.classList.toggle('female-theme', gender === 'female');
        }

        function updateLanguageButtonText() {
            const btn = document.getElementById('lang-toggle-btn');
            if (btn) {
                btn.textContent = currentLang === 'en' ? 'Ø¹Ø±Ø¨ÙŠ / English' : 'English / Ø¹Ø±Ø¨ÙŠ';
            }
        }

        function applyTranslations() {
            const html = document.documentElement;
            const newDir = currentLang === 'ar' ? 'rtl' : 'ltr';
            html.setAttribute('lang', currentLang);
            html.setAttribute('dir', newDir);
            
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = translations[currentLang][key];
                if (element.tagName === 'TITLE') {
                    document.title = translation || element.textContent;
                } else if (translation) {
                    element.textContent = translation;
                }
            });
            updateLanguageButtonText(); 
        }
        
        window.loadUserPreferences = function() {
            const savedGender = localStorage.getItem('malfitGender') || 'male';
            userGender = savedGender;
            currentLang = localStorage.getItem('malfitLang') || 'en'; 
            updateTheme(userGender);
            applyTranslations();
        }

        window.toggleLanguage = function() {
            const newLang = currentLang === 'en' ? 'ar' : 'en';
            currentLang = newLang;
            localStorage.setItem('malfitLang', newLang);
            applyTranslations();
            document.getElementById('message-box').classList.add('hidden');
        }

        function displayMessage(messageKey, isSuccess) {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const translation = translations[currentLang][messageKey] || messageKey;
            
            box.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'text-green-800', 'bg-red-100', 'border-red-500', 'text-red-800');
            
            if (isSuccess) {
                box.classList.add('bg-green-100', 'border-green-500');
                text.classList.add('text-green-800');
            } else {
                box.classList.add('bg-red-100', 'border-red-500');
                text.classList.add('text-red-800');
            }
            text.textContent = translation;
        }

        window.changePassword = async function() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const user = auth.currentUser; // Get the currently signed-in user

            if (!currentPassword || !newPassword || !confirmPassword) {
                displayMessage('error_fill_all', false);
                return;
            }

            if (newPassword !== confirmPassword) {
                displayMessage('error_match', false);
                return;
            }

            if (!user || !user.email) {
                displayMessage('error_no_user', false); // User not logged in
                return;
            }
            
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await user.reauthenticateWithCredential(credential);

                await user.updatePassword(newPassword);

                displayMessage('success_password_changed', true);
                
                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 1500);

            } catch (error) {
                let messageKey = 'error_fill_all'; 
                
                if (error.code === 'auth/wrong-password') {
                    messageKey = 'error_current_password'; 
                } else if (error.code === 'auth/requires-recent-login') {
                    messageKey = 'error_no_user'; 
                } else if (error.code === 'auth/weak-password') {
                    messageKey = 'error_weak_password'; 
                }
                
                displayMessage(messageKey, false);
                console.error("Firebase Password Update Error:", error.code, error.message);
            }
        }
    </script>
</body>
</html>
